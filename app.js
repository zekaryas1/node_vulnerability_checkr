const express = require('express');
const exphbs = require('express-handlebars');
const fileUpload = require('express-fileupload');
const axios = require('axios').default;

const app = express();

app.engine('handlebars', exphbs());
app.set('view engine', 'handlebars');
app.use(express.static(__dirname + '/public'));
// enable files upload
app.use(fileUpload({
    createParentPath: true
}));

app.get('/', function (req, res) {
    res.render('home', {
        showIllustration: true
    });
});

app.post("/", async (req, res) => {
    if (!req.files) {
        res.render('home', {
            showIllustration: true,
            error: "submit json file"
        });
        return;
    }
    console.log(req.files.package.mimetype);
    if (req.files.package.mimetype !== "application/json") {
        res.render('home', {
            showIllustration: true,
            error: "only json is supported"
        });
        return;
    }

    const fileContent = req.files.package.data.toString('utf8');
    const jsonFileContent = JSON.parse(fileContent);
    if (jsonFileContent.dependencies) {
        const resultArray = toSimpleArray(jsonFileContent.dependencies);
        try {
            const remoteResponse = await axios.post("https://ossindex.sonatype.org/api/v3/component-report", {
                coordinates: resultArray
            });
            res.render('home', {
                showIllustration: false,
                data: remoteResponse.data
            });
        } catch (error) {
            console.error(error);
            res.render('home', {
                showIllustration: false,
                error: "Input format is wrong or connection problem"
            });
        }

    }
});


function toSimpleArray(jsonObject) {
    const toReturn = [];
    for (let obj in jsonObject) {
        const correct_version = jsonObject[obj].slice(1);
        if (obj.startsWith("@")) {
            obj = obj.slice(1, obj.length);
        }
        toReturn.push(`pkg:npm/${obj}@${correct_version}`);
    }
    return toReturn;
}

const port = process.env.PORT || 3000;
app.listen(port, () => {
    console.log("server working on " + port);
});