const {default: axios} = require("axios");
const {terminal: term} = require("terminal-kit");


/**
 * coverts common package.json dep formats to ossindex vulnerability search format
 * i.e "axios": "^1.2.1" to axios@1.2.1
 * @param listOfDependencies
 * @returns {*[]}
 */
exports.format = listOfDependencies => {
    const ossFormat = [];
    for (const dependency in listOfDependencies) {
        let packageName = dependency;
        let version = listOfDependencies[packageName];

        if (packageName.startsWith("@")) {
            packageName = packageName.slice(1, dependency.length);
        }
        if (version.startsWith("^")) {
            version = version.slice(1);
        }
        ossFormat.push(`pkg:npm/${packageName}@${version}`);
    }
    return ossFormat;
};


/**
 * get response from ossindex.sonatype.org
 * @param listOfDependencies package.json dep in ossindex format
 * @returns {Promise<any>}
 */
exports.makeRequest = async listOfDependencies => {
    try {
        const remoteResponse = await axios.post(
            "https://ossindex.sonatype.org/api/v3/component-report",
            {
                coordinates: listOfDependencies,
            }
        );
        return remoteResponse.data;
    } catch (error) {
        term.red(error.message);
    }
};