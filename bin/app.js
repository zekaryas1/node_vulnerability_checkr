#!/usr/bin/env node
const {readPackageJson, getAllDependencies, prettyPrint} = require("./common");
const OSSIndex = require("./ossindex");
const term = require('terminal-kit').terminal;

/**
 * entry point of the program
 * @returns {Promise<void>}
 */
const runProgram = async () => {
    const content = await readPackageJson("./package.json");
    const dependencies = await getAllDependencies(content);
    const responses = await OSSIndex.makeRequest(OSSIndex.format(dependencies));

    const noVulnerability = responses.reduce((sum, response) => {
        return sum + response.vulnerabilities.length;
    }, 0);

    if (noVulnerability === 0) {
        term.green.bold(`\n-> Congratulation! Program Found ${noVulnerability} vulnerabilities In total\n`);
        return;
    }

    term.bold.red(`\n-> Program Found ${noVulnerability} vulnerabilities In total\n`);
    if (noVulnerability !== 0) {
        responses.forEach(response => {
            if (response.vulnerabilities.length > 0) {
                term.bold.red(`\n-> Found ${response.vulnerabilities.length} vulnerabilities for ${response.coordinates}\n`);
                prettyPrint(response)
            }
        })
    }
};

term.bold.underline("Using https://ossindex.sonatype.org to check vulnerability...\n");
runProgram();