#!/usr/bin/env node
const {readPackageJson, getAllDependencies, prettyPrint} = require("./common");
const term = require('terminal-kit').terminal;
const yargs = require("yargs");
const providers = {
    oss: {url: "using oss index", import: require('./ossindex')},
    osv: {url: "using osv index", import: require('./osvindex')}
}
let index = {};

const options = yargs
    .usage("Usage: check -with <provider-name>")
    .option("with", {
        alias: "provider",
        describe: "Which vulnerability provider you want to use, i.e oss | osv",
        type: "string",
        demandOption: true
    })
    .argv;

if (options.with && providers[options.with]) {
    index = providers[options.with];
} else {
    term.red("Please provide a proper provider with");
    process.exit();
}

/**
 * entry point of the program
 * @returns {Promise<void>}
 */
const runProgram = async () => {
    const content = await readPackageJson("./package.json");
    const dependencies = await getAllDependencies(content);
    const responses = await index.import.makeRequest(index.import.format(dependencies));

    if (responses.length === 0) {
        term.green.bold(`\n-> Congratulation! Program Found 0 vulnerabilities In total\n`);
        return;
    }

    term.bold.red(`\n-> Program Found ${responses.length} vulnerabilities In total\n`);
    prettyPrint(responses);
};

term.bold.underline(`Using ${index.url} to check vulnerability...\n`);
runProgram();